#include <math.h>

#define SENS_PIN 0

// ADC , Temp , Coef i - 1
float tab[110][3] = {
{ 1.00 , -86.99 , 18.60 },
{ 10.00 , -60.33 , 2.67 },
{ 20.00 , -50.63 , 0.97 },
{ 30.00 , -44.48 , 0.62 },
{ 40.00 , -39.85 , 0.46 },
{ 50.00 , -36.10 , 0.38 },
{ 60.00 , -32.90 , 0.32 },
{ 70.00 , -30.11 , 0.28 },
{ 80.00 , -27.60 , 0.25 },
{ 90.00 , -25.33 , 0.23 },
{ 100.00 , -23.23 , 0.21 },
{ 110.00 , -21.29 , 0.19 },
{ 120.00 , -19.46 , 0.18 },
{ 130.00 , -17.74 , 0.17 },
{ 140.00 , -16.11 , 0.16 },
{ 150.00 , -14.56 , 0.16 },
{ 160.00 , -13.07 , 0.15 },
{ 170.00 , -11.64 , 0.14 },
{ 180.00 , -10.26 , 0.14 },
{ 190.00 , -8.92 , 0.13 },
{ 200.00 , -7.63 , 0.13 },
{ 210.00 , -6.37 , 0.13 },
{ 220.00 , -5.15 , 0.12 },
{ 230.00 , -3.95 , 0.12 },
{ 240.00 , -2.78 , 0.12 },
{ 250.00 , -1.63 , 0.11 },
{ 260.00 , -0.51 , 0.11 },
{ 270.00 , 0.60 , 0.11 },
{ 280.00 , 1.69 , 0.11 },
{ 290.00 , 2.76 , 0.11 },
{ 300.00 , 3.82 , 0.11 },
{ 310.00 , 4.87 , 0.10 },
{ 320.00 , 5.90 , 0.10 },
{ 330.00 , 6.93 , 0.10 },
{ 340.00 , 7.95 , 0.10 },
{ 350.00 , 8.95 , 0.10 },
{ 360.00 , 9.96 , 0.10 },
{ 370.00 , 10.95 , 0.10 },
{ 380.00 , 11.95 , 0.10 },
{ 390.00 , 12.93 , 0.10 },
{ 400.00 , 13.92 , 0.10 },
{ 410.00 , 14.90 , 0.10 },
{ 420.00 , 15.89 , 0.10 },
{ 430.00 , 16.87 , 0.10 },
{ 440.00 , 17.85 , 0.10 },
{ 450.00 , 18.83 , 0.10 },
{ 460.00 , 19.82 , 0.10 },
{ 470.00 , 20.80 , 0.10 },
{ 480.00 , 21.80 , 0.10 },
{ 490.00 , 22.79 , 0.10 },
{ 500.00 , 23.79 , 0.10 },
{ 510.00 , 24.80 , 0.10 },
{ 520.00 , 25.81 , 0.10 },
{ 530.00 , 26.83 , 0.10 },
{ 540.00 , 27.86 , 0.10 },
{ 550.00 , 28.90 , 0.10 },
{ 560.00 , 29.95 , 0.10 },
{ 570.00 , 31.01 , 0.11 },
{ 580.00 , 32.08 , 0.11 },
{ 590.00 , 33.16 , 0.11 },
{ 600.00 , 34.26 , 0.11 },
{ 610.00 , 35.38 , 0.11 },
{ 620.00 , 36.51 , 0.11 },
{ 630.00 , 37.66 , 0.12 },
{ 640.00 , 38.83 , 0.12 },
{ 650.00 , 40.02 , 0.12 },
{ 660.00 , 41.24 , 0.12 },
{ 670.00 , 42.48 , 0.12 },
{ 680.00 , 43.74 , 0.13 },
{ 690.00 , 45.04 , 0.13 },
{ 700.00 , 46.36 , 0.13 },
{ 710.00 , 47.72 , 0.14 },
{ 720.00 , 49.12 , 0.14 },
{ 730.00 , 50.55 , 0.14 },
{ 740.00 , 52.03 , 0.15 },
{ 750.00 , 53.55 , 0.15 },
{ 760.00 , 55.13 , 0.16 },
{ 770.00 , 56.76 , 0.16 },
{ 780.00 , 58.45 , 0.17 },
{ 790.00 , 60.20 , 0.18 },
{ 800.00 , 62.03 , 0.18 },
{ 810.00 , 63.95 , 0.19 },
{ 820.00 , 65.95 , 0.20 },
{ 830.00 , 68.05 , 0.21 },
{ 840.00 , 70.26 , 0.22 },
{ 850.00 , 72.60 , 0.23 },
{ 860.00 , 75.09 , 0.25 },
{ 870.00 , 77.74 , 0.26 },
{ 880.00 , 80.57 , 0.28 },
{ 890.00 , 83.63 , 0.31 },
{ 900.00 , 86.95 , 0.33 },
{ 910.00 , 90.58 , 0.36 },
{ 920.00 , 94.58 , 0.40 },
{ 930.00 , 99.04 , 0.45 },
{ 940.00 , 104.07 , 0.50 },
{ 950.00 , 109.85 , 0.58 },
{ 960.00 , 116.62 , 0.68 },
{ 970.00 , 124.75 , 0.81 },
{ 980.00 , 134.92 , 1.02 },
{ 990.00 , 148.34 , 1.34 },
{ 1000.00 , 167.72 , 1.94 },
{ 1010.00 , 201.14 , 3.34 },
{ 1020.00 , 301.28 , 10.01 },
};

// Hard way to calculate the Temp
float Calcul_Temp(int RawADC)
{
 float Temp;
 float var_c = 3435.0;
 float var_d = 10000.0;
 float var_e = 298.15;
 
 Temp = 1.0 / (( 1.0 / var_e ) + 1.0 / var_c *log(1024.0 / float(RawADC) - 1.0 ));
 
 /*
  * Old calculation methode
  * Temp = log(10000.0*((1024.0/RawADC-1))); 
  * Temp = 1 / (0.001129148 + (0.000234125 + (0.0000000876741 * Temp * Temp ))* Temp );
  */
 Temp = Temp - 273.15;
 return (Temp);
}

// Display the tab like in Excel
void Create_Tab()
{
 int i = 1;
 float tmp;
 float tmp2 = -273.0;
 while (i < 1024)
  {
    Serial.print("{ ");
    Serial.print(float(i));
    Serial.print(" , ");
    tmp = float(Calcul_Temp(i));
    Serial.print(tmp);
    Serial.print(" , ");
    Serial.print((tmp - tmp2) / 10);
    Serial.println(" },");
    tmp2 = tmp;
    if (i == 1)
      i = 0;
    i = i + 10;
  }
  delay(10000000);
}

// Esay way to calculate the temp with the tab
float Calcul_Temp_Tab(int RawADC)
{
 int i = 0;
 float res = 0.0;
 float coef = 0.0;
 
 while(tab[i][0] < RawADC && i < 990)
 {
  i++;
 }
    if (RawADC % 10== 0)
    {
       res = float(tab[i][1]);
    }
    else
    {
       res = float(tab[i - 1][1]) + tab[i][2] * float(RawADC % 10);
    }
   return (res);
}

// Function for unit_testing
void Unit_Test()
{
  int adc;
  adc = 1;
  while( adc<990) {
    float temp = Calcul_Temp_Tab(adc);
    Serial.print(adc);
    Serial.print(" , ");
    Serial.println(temp);
    adc = adc + 1;
  }
  delay(10000000);
}

void setup() {
 Serial.begin(57600);
 Unit_Test();
 //Create_Tab();
}

void loop()
{
 int RawADC = analogRead(SENS_PIN);
 Serial.print(RawADC);
 Serial.print(" ");
 Serial.println(Calcul_Temp_Tab(RawADC));
 delay(1000);
}
