#include <math.h>

#define SENS_PIN 0

float tab[200][2] = {
{ 1.00 , -83.64 },
{ 11.00 , -54.40 },
{ 21.00 , -45.19 },
{ 31.00 , -39.28 },
{ 41.00 , -34.83 },
{ 51.00 , -31.22 },
{ 61.00 , -28.16 },
{ 71.00 , -25.49 },
{ 81.00 , -23.11 },
{ 91.00 , -20.95 },
{ 101.00 , -18.97 },
{ 111.00 , -17.13 },
{ 121.00 , -15.41 },
{ 131.00 , -13.80 },
{ 141.00 , -12.27 },
{ 151.00 , -10.81 },
{ 161.00 , -9.42 },
{ 171.00 , -8.09 },
{ 181.00 , -6.81 },
{ 191.00 , -5.57 },
{ 201.00 , -4.37 },
{ 211.00 , -3.21 },
{ 221.00 , -2.08 },
{ 231.00 , -0.98 },
{ 241.00 , 0.10 },
{ 251.00 , 1.15 },
{ 261.00 , 2.18 },
{ 271.00 , 3.19 },
{ 281.00 , 4.19 },
{ 291.00 , 5.16 },
{ 301.00 , 6.13 },
{ 311.00 , 7.08 },
{ 321.00 , 8.02 },
{ 331.00 , 8.95 },
{ 341.00 , 9.87 },
{ 351.00 , 10.78 },
{ 361.00 , 11.68 },
{ 371.00 , 12.58 },
{ 381.00 , 13.47 },
{ 391.00 , 14.36 },
{ 401.00 , 15.24 },
{ 411.00 , 16.12 },
{ 421.00 , 17.00 },
{ 431.00 , 17.88 },
{ 441.00 , 18.75 },
{ 451.00 , 19.63 },
{ 461.00 , 20.50 },
{ 471.00 , 21.38 },
{ 481.00 , 22.26 },
{ 491.00 , 23.14 },
{ 501.00 , 24.02 },
{ 511.00 , 24.91 },
{ 521.00 , 25.80 },
{ 531.00 , 26.70 },
{ 541.00 , 27.60 },
{ 551.00 , 28.52 },
{ 561.00 , 29.43 },
{ 571.00 , 30.36 },
{ 581.00 , 31.30 },
{ 591.00 , 32.24 },
{ 601.00 , 33.20 },
{ 611.00 , 34.17 },
{ 621.00 , 35.15 },
{ 631.00 , 36.15 },
{ 641.00 , 37.16 },
{ 651.00 , 38.19 },
{ 661.00 , 39.24 },
{ 671.00 , 40.30 },
{ 681.00 , 41.39 },
{ 691.00 , 42.50 },
{ 701.00 , 43.63 },
{ 711.00 , 44.79 },
{ 721.00 , 45.98 },
{ 731.00 , 47.21 },
{ 741.00 , 48.46 },
{ 751.00 , 49.75 },
{ 761.00 , 51.08 },
{ 771.00 , 52.46 },
{ 781.00 , 53.88 },
{ 791.00 , 55.36 },
{ 801.00 , 56.89 },
{ 811.00 , 58.49 },
{ 821.00 , 60.16 },
{ 831.00 , 61.91 },
{ 841.00 , 63.75 },
{ 851.00 , 65.69 },
{ 861.00 , 67.74 },
{ 871.00 , 69.92 },
{ 881.00 , 72.24 },
{ 891.00 , 74.74 },
{ 901.00 , 77.45 },
{ 911.00 , 80.39 },
{ 921.00 , 83.62 },
{ 931.00 , 87.20 },
{ 941.00 , 91.23 },
{ 951.00 , 95.82 },
{ 961.00 , 101.17 },
{ 971.00 , 107.57 },
{ 981.00 , 115.49 },
{ 991.00 , 125.87 },
{ 1001.00 , 140.72 },
{ 1011.00 , 166.17 },
{ 1021.00 , 246.61 },
};

// Hard way to calculate the Temp
float Calcul_Temp(int RawADC)
{
 double Temp;
 Temp = log(10000.0*((1024.0/RawADC-1))); 
 Temp = 1 / (0.001129148 + (0.000234125 + (0.0000000876741 * Temp * Temp ))* Temp );
 Temp = Temp - 273.15;
 return (Temp);
}

// Display the tab like in Excel
void Create_Tab()
{
 int i = 1;
 while (i < 1024)
  {
    Serial.print("{ ");
    Serial.print(float(i));
    Serial.print(" , ");
    Serial.print(float(Calcul_Temp(i)));
    Serial.println(" },");
    i = i + 10;
  }
  delay(10000000);
}

// Esay way to calculate the temp with the tab
float Calcul_Temp_Tab(int RawADC)
{
 int i = 0;
 float res = 0.0;
 float coef = 0.0;
 
 while(tab[i][0] < RawADC && i < 990)
 {
  i++;
 }
 if (RawADC % 10 != 0)
 {
   coef = (float(tab[i][1]) - float(tab[i - 1][1])) / 10.0;
   res = float(tab[i - 1][1]) + coef * float(RawADC % 10);
   return (res);
 }
 return (tab[i][1]);
}

// Function for unit_testing
void Unit_Test()
{
  int adc;
  adc = 1;
  while( adc<990) {
    int temp = Calcul_Temp_Tab(adc);
    Serial.print(adc);
    Serial.print(" , ");
    Serial.println(temp);
    adc = adc + 1;
  }
  delay(10000000);
}

void setup() {
 Serial.begin(57600);
 //Unit_Test();
 
 //Create_Tab();
}

void loop()
{
 int RawADC = analogRead(SENS_PIN);
 Serial.print(RawADC);
 Serial.print(" ");
 Serial.println(Calcul_Temp_Tab(RawADC));
 delay(1000);
}
